/**
 * @author Hakim El Hattab | http://hakim.se
 */
function Entity(){this.alive=!1}Entity.prototype=new Point;function Player(){this.trail=[];this.size=8;this.length=45;this.energy=100;this.animatedEnergy=0;this.adjustEnergy=function(q){this.energy=Math.min(Math.max(this.energy+q,0),100)}}Player.prototype=new Entity;function Enemy(){this.scale=0.01;this.scaleTarget=1;this.alpha=0;this.alphaTarget=1;this.time=0;this.type=1;this.velocity={x:0,y:0};this.alive=!0}Enemy.prototype=new Entity;
function Particle(q,t,s,E){this.x=q;this.y=t;this.velocity={x:-s+2*Math.random()*s,y:-s+2*Math.random()*s};this.color=E;this.alpha=1;this.fading=!1}Particle.prototype=new Entity;function Notification(q,t,s,E,K){this.text=q||"";this.x=t||0;this.y=s||0;this.scale=E||1;this.rgb=K||[255,255,255];this.alpha=1}Notification.prototype=new Entity;function Effect(q,t,s){this.x=t||0;this.y=s||0;this.time=q||0;this.alive=!1}
function Multiplier(q,t){this.major=1;this.minor=0;this.max=t;this.step=q;this.reset=function(){this.major=1;this.minor=0};this.increase=function(){for(this.minor+=this.step;1<=this.minor;)this.major<this.max&&this.major++,this.minor=1-this.minor}}
var Coil=function(){var q,t,s,E,K,x,Y,y,k,m;function Ha(){f.clearColor(0,0,0,0);var b=$("#vertexShader").text(),a=$("#fragmentShader").text();z=WebGLUtil.createShaderProgram(f,b,a);na=new Float32Array([-1,-1,1,-1,-1,1,1,-1,1,1,-1,1]);Z=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,Z);f.bufferData(f.ARRAY_BUFFER,na,f.STATIC_DRAW);aa=WebGLUtil.loadTexture(f,"images/texture.png",FunctionUtil.delegate(this,function(){WebGLUtil.bindTexture(f,aa);if(f.getProgramParameter(z,f.LINK_STATUS)){F=!0;f.viewport(0,
	WebGL: INVALID_VALUE: getProgramParameter: no object or object deleted
	0,1024,1024);f.useProgram(z);var a=f.getUniformLocation(z,"texture");f.uniform1i(a,0);f.activeTexture(f.TEXTURE0);f.bindTexture(f.TEXTURE_2D,aa);u.show();ba()}else F=!1}))}function Ia(){var b,a;b=$("<canvas/>").attr("width",64).attr("height",64).get(0);a=b.getContext("2d");a.beginPath();a.arc(32,32,ENEMY_SIZE,0,2*Math.PI,!0);a.lineWidth=2;a.fillStyle="rgba(0,200,220, 0.9)";a.strokeStyle="rgba(255,255,255,0.4)";a.shadowColor="rgba(0,240,255,0.9)";a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=20;
	a.stroke();a.fill();q=b;b=$("<canvas/>").attr("width",64).attr("height",64).get(0);a=b.getContext("2d");a.beginPath();a.arc(32,32,1.4*ENEMY_SIZE,0,2*Math.PI,!0);a.lineWidth=2;a.fillStyle="rgba(190,220,90, 0.9)";a.strokeStyle="rgba(255,255,255,0.4)";a.shadowColor="rgba(220,240,150,0.9)";a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=20;a.stroke();a.fill();t=b;b=$("<canvas/>").attr("width",64).attr("height",64).get(0);a=b.getContext("2d");a.beginPath();a.arc(32,32,1.4*ENEMY_SIZE,0,2*Math.PI,!0);a.lineWidth=
		2;a.fillStyle="rgba(190,220,90, 0.9)";a.strokeStyle="rgba(255,255,255,0.4)";a.shadowColor="rgba(220,240,150,0.9)";a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=10;a.stroke();a.fill();s=b;b=$("<canvas/>").attr("width",64).attr("height",64).get(0);a=b.getContext("2d");a.beginPath();a.arc(32,32,ENEMY_SIZE,0,2*Math.PI,!0);a.lineWidth=2;a.fillStyle="rgba(220,50,50, 0.9)";a.strokeStyle="rgba(255,255,255,0.4)";a.shadowColor="rgba(255,100,100,0.9)";a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=10;a.stroke();
	a.fill();E=b}function oa(){for(;v.length<ca;)v.push(new Effect(0,0,0))}function Ja(b){Ka();b.preventDefault()}function La(b){Ma();b.preventDefault()}function Na(b){P.fadeOut();F=!1;v=[];n=0;u.fadeOut(pa).hide();b.preventDefault()}function Oa(){}function Pa(b){K=x;Y=y;x=b.clientX-0.5*(window.innerWidth-k);y=b.clientY-0.5*(window.innerHeight-m);Math.abs(x-K);Math.abs(y-Y)}function Qa(){}function Ra(b){1==b.touches.length&&(b.preventDefault(),x=b.touches[0].pageX-0.5*(window.innerWidth-k),y=b.touches[0].pageY-
	0.5*(window.innerHeight-m))}function Sa(b){1==b.touches.length&&(b.preventDefault(),x=b.touches[0].pageX-0.5*(window.innerWidth-k),y=b.touches[0].pageY-0.5*(window.innerHeight-m)-20)}function Ta(){}function ba(){k=UserProfile.isTouchDevice()?window.innerWidth:qa;m=UserProfile.isTouchDevice()?window.innerHeight:ra;L.width(k);L.height(m);o.get(0).width=k;o.get(0).height=m;var b=Math.max(0.5*(window.innerWidth-k),1),a=Math.max(0.5*(window.innerHeight-m),1);L.css({left:b,top:a});A.css({left:(k-A.width())/
	2,top:(m-A.height())/2});if(F)u.get(0).width=k,u.get(0).height=m,f.viewportWidth=k,f.viewportHeight=m}function Ma(){sa();Q=da=Date.now();G=!0;A.fadeOut(pa,function(){$("h1",this).remove()});document.body.setAttribute("class",Ua)}function sa(){i=new Player;i.x=x;i.y=y;B=[];C=[];D=[];p=[];v=[];R=w=0;G=!1;S=1;n=0;oa();r.reset();Q=da=ea=H=0}function Va(){$.post(fa,{method:"load"}).success(function(b){var d;g=$.parseJSON(b);a:{if(g&&!1===G){for(var b=1,a=0;a<g.length;a++)g[a].score>w&&b++;if(10>b){if(1<
	g.length&&(a=9<=g.length?g.pop():{})){a.name="";a.score=Math.round(w);a.date="";var c=g.slice(0,b-1);c.push(a);d=c=c.concat(g.slice(b-1)),g=d;ga()}b=!0;break a}}b=!1}document.body.setAttribute("class",b?STATE_WINNER:ta)}).error(function(){})}function Wa(){$.post(fa,{method:"load"}).success(function(b){g=$.parseJSON(b);ga()}).error(function(){})}function Ka(){var b=$('input[type="text"]',ua).val(),a=Math.round(100*(R/1E3))/100,c=3.14159265*w*w*Math.max(b.length,1);va=b;b={method:"save",n:b,s:c,d:a,
	fc:Math.round(H),fs:Math.round(ea),f:Math.round((T+U+I)/3)};$.post(fa,b).success(function(a){g=$.parseJSON(a);ga();document.body.setAttribute("class",ta)}).error(function(){alert("An error occured while saving your score :(")})}function ga(){for(var b='<tr><th width="90">Name</th><th width="40">Score</th><th width="70">Date</th></tr>',a=0;a<g.length;a++){var c="";if(""===g[a].name||g[a].name===va)c='class="yours"';b+="<tr "+c+'><td width="90">'+g[a].name+'</span><td width="40">'+g[a].score+'</span><td width="70">'+
	g[a].date+"</span></tr>"}$("table",wa).html(b)}function V(b,a){if(F)n++,n>=ca&&(n=0),v[n].x=b,v[n].y=a,v[n].time=0,v[n].alive=!0}function M(b,a,c,e){J.push({x:b,y:a,width:c,height:e})}function ha(b){var a=0;G&&(a=b*r.major,w+=a*(I/W));return a}function xa(){for(var b=J.length;b--;){var a=J[b];c.clearRect(Math.floor(a.x),Math.floor(a.y),Math.ceil(a.width),Math.ceil(a.height))}J=[];if(G){c.save();c.globalCompositeOperation="lighter";b=Date.now();ia++;b>ja+1E3&&(I=Math.min(Math.round(1E3*ia/(b-ja)),
	W),T=Math.min(T,I),U=Math.max(U,I),ja=b,ia=0);ya=b-Q;ka=ya/(1E3/W);S+=0.002*Math.max(ka,1);ha(1);H++;ea++;R=b-da;Q=b;H>6*W&&30>Math.round((T+U+I)/3)&&F&&P.fadeIn(N);for(i.interpolate(x,y,0.4);i.trail.length<i.length;)i.trail.push(new Point(i.x,i.y));i.trail.shift();0===i.energy&&(za.show().find("p").text(Math.floor(w)),G=!1,A.fadeIn(N),Va());for(b=D.length;b--;){a=D[b];a.x+=a.velocity.x;a.y+=a.velocity.y;a.velocity.x*=0.98;a.velocity.y*=0.98;if(!0===a.fading)a.alpha*=0.92;else if(0.92<Math.random())a.fading=
	!0;0.05>a.alpha&&D.splice(b,1)}b=i.trail.length;for(a=[];b--;)for(var d=i.trail.length,e=i.trail[b],h=i.trail[b+1];d--;)if(1<Math.abs(b-d)){var g=i.trail[d],n=i.trail[d+1];if(e&&h&&g&&n){var j;j=h.x-e.x;var l=h.y-e.y,o=n.x-g.x,u=n.y-g.y,n=(-l*(e.x-g.x)+j*(e.y-g.y))/(-o*l+j*u),g=(o*(e.y-g.y)-u*(e.x-g.x))/(-o*l+j*u);(j=0<=n&&1>=n&&0<=g&&1>=g?{x:e.x+g*j,y:e.y+g*l}:null)&&a.push([Math.min(b,d),Math.max(b,d),j])}}for(C=[];a.length;){b=C.length;for(d=a.pop();b--;)d&&C[b]&&d[0]===C[b][0]&&d[1]===C[b][1]&&
(d=null);d&&C.push(d)}for(;C.length;){b=C.pop();c.beginPath();a=i.trail.slice(b[0],b[1]);a[0]=b[2];a.push(b[2]);d=new Region;b=0;for(e=a.length;b<e;b++)h=a[b],j=a[b+1],0===b?c.moveTo(h.x,h.y):h&&j&&c.quadraticCurveTo(h.x,h.y,h.x+(j.x-h.x)/2,h.y+(j.y-h.y)/2),d.inflate(h.x,h.y);d.center();c.fillStyle="rgba(0,255,255,0.2)";c.closePath();c.fill()}if(1==H%2){b=c.getImageData(0,0,k,m);a=b.width;e=b.data;d=[];for(b=p.length;b--;){h=p[b];j=Math.round(h.x);l=Math.round(h.y);j=[4*(l*a+Math.round(j-ENEMY_SIZE)),
	4*(l*a+Math.round(j+ENEMY_SIZE)),4*(Math.round(l-ENEMY_SIZE)*a+j),4*(Math.round(l+ENEMY_SIZE)*a+j)];for(l=j.length;l--;)if(g=j[l],255===e[g+1]&&255===e[g+2]){if(h.type===O||h.type===X)i.adjustEnergy(Aa),r.reset(),B.push(new Notification(Aa+"\u2665",h.x,h.y,1.2,[230,90,90])),V(h.x,h.y);else{j=h;i.adjustEnergy(Xa);l=r.major;r.increase();r.major>l&&(B.push(new Notification("X"+r.major,k/2,m/2,r.major,[60,250,130])),V(k/2,m/2));l=j.x;g=j.y;for(o=6;o--;)D.push(new Particle(l,g,3,"#eeeeee"));l=ha(Ba);B.push(new Notification(""+
	Math.floor(l),j.x,j.y,void 0,void 0));V(j.x,j.y);d.push(h)}p.splice(b,1);break}}1<d.length&&(b=ha(d.length*Ba),B.push(new Notification(b,i.x,i.y-10,d.length/1.5,[250,250,100])))}c.beginPath();b=new Region;a=i.trail.length;a=0;for(d=i.trail.length;a<d;a++)e=i.trail[a],h=i.trail[a+1],0===a?c.moveTo(e.x+(h.x-e.x)/2,e.y+(h.y-e.y)/2):h&&c.quadraticCurveTo(e.x,e.y,e.x+(h.x-e.x)/2,e.y+(h.y-e.y)/2),b.inflate(e.x,e.y);c.strokeStyle="#648d93";c.lineWidth=2;c.stroke();b.expand(4,4);b=b.toRectangle();M(b.x,b.y,
	b.width,b.height);b=p.length;for(a=0;b--;)p[b].type===O&&a++;d=0.4>a/p.length;for(b=Math.floor(Ya+S)-p.length;b--&&0.85<Math.random();)e=Ca,d&&(e=0.5<Math.random()?Ca:O),a=new Enemy,a.x=60+Math.round(Math.random()*(k-60-60)),a.y=60+Math.round(Math.random()*(m-60-60)),a.type=e,p.push(a);for(b=p.length;b--;){a=p[b];a.time=Math.min(a.time+0.2*ka,100);a.scale+=0.3*(a.scaleTarget-a.scale+0.01);a.alpha+=0.1*(a.alphaTarget-a.alpha);if(a.type===X||a.type===Za)if(a.x+=a.velocity.x,a.y+=a.velocity.y,0>a.x||
	a.x>k-ENEMY_SIZE)a.velocity.x=-a.velocity.x;else if(0>a.y||a.y>m-ENEMY_SIZE)a.velocity.y=-a.velocity.y;if(a.alive&&100===a.time){if(a.type===O||a.type===X)d=a,d.alphaTarget=0,d.scaleTarget=0.01;else{d=a;i.adjustEnergy(Da);r.reset();e=d.x;h=d.y;for(j=15;j--;)D.push(new Particle(e,h,3,"#eeeeee"));B.push(new Notification(Da+"\u2665",d.x,d.y,1.2,[230,90,90]));V(d.x,d.y);p.splice(b,1)}a.alive=!1}!1===a.alive&&0===a.alphaTarget&&0.05>a.alpha&&p.splice(b,1)}for(b=p.length;b--;)a=p[b],d=null,a.type===O||
	a.type===X?d=E:(d=q,65<a.time&&(d=t,0==Math.round(a.time)%2&&(d=s))),c.save(),c.globalAlpha=a.alpha,c.translate(Math.round(a.x),Math.round(a.y)),c.scale(a.scale,a.scale),c.drawImage(d,-Math.round(d.width/2),-Math.round(d.height/2)),c.restore(),e=d.width*a.scale+4,M(a.x-e/2,a.y-e/2,e,d.height*a.scale+4);for(b=D.length;b--;)a=D[b],c.save(),c.globalAlpha=a.alpha,c.fillStyle=a.color,c.fillRect(a.x,a.y,1,1),c.restore(),M(a.x-2,a.y-2,4,4);c.restore();for(b=B.length;b--;)a=B[b],a.y-=0.4,d=14*a.scale,c.save(),
	c.font="bold "+Math.round(12*a.scale)+"px Arial",c.beginPath(),c.fillStyle="rgba(0,0,0,"+0.7*a.alpha+")",c.arc(a.x,a.y,d,0,2*Math.PI,!0),c.fill(),c.fillStyle="rgba( "+a.rgb[0]+", "+a.rgb[1]+", "+a.rgb[2]+", "+a.alpha+" )",c.fillText(a.text,a.x-0.5*c.measureText(a.text).width,a.y+4*a.scale),c.restore(),a.alpha*=1-0.08*(1-(a.alpha-0.08)/1),0.05>a.alpha&&B.splice(b,1),d+=2,M(a.x-d,a.y-d,2*d,2*d)}if(F){for(b=v.length;b--;)if(a=v[b],a.time=a.alive?Math.min((a.time+0.01)*(1+(1-a.time)),1):Math.max(0.99*
	(a.time-0.01),0),1===a.time)a.alive=!1;if(0==H%2){la+=0.01;b=f.getAttribLocation(z,"position");a=f.getUniformLocation(z,"time");d=f.getUniformLocation(z,"resolution");e=f.getUniformLocation(z,"mouse");f.bindBuffer(f.ARRAY_BUFFER,Z);f.uniform1f(a,la);f.uniform2f(d,k,m);f.uniform2f(e,x,y);for(a=ca;a--;)d=v[a],e=f.getUniformLocation(z,"e"+a),f.uniform3f(e,d.x,d.y,d.time);f.vertexAttribPointer(b,2,f.FLOAT,!1,0,0);f.enableVertexAttribArray(b);f.drawArrays(f.TRIANGLES,0,6);f.disableVertexAttribArray(b)}}if(0!==
	w){i.animatedEnergy+=0.2*(i.energy-i.animatedEnergy);c.fillStyle="rgba(0,0,0,0.5)";c.fillRect(0,0,k,Ea);c.save();c.translate(10,10);c.font="10px Arial";c.fillStyle="#ffffff";c.fillText("ENERGY:",0,8);c.translate(56,0);c.save();c.fillStyle="rgba(40,40,40,0.8)";c.fillRect(0,2,100,4);c.shadowOffsetX=0;c.shadowOffsetY=0;c.shadowBlur=14;c.shadowColor="rgba(0,240,255,0.9)";c.fillStyle="rgba(0,200,220, 0.8)";c.fillRect(0,2,100*(i.animatedEnergy/100),4);c.restore();c.translate(122,0);c.font="10px Arial";
	c.fillStyle="#ffffff";c.fillText("MULTIPLIER:",0,8);c.translate(73,0);for(b=ma-1;b--;){c.save();c.beginPath();a=6+80*(b/ma);c.fillStyle="rgba(40,40,40,0.8)";c.arc(a,5,6,0,2*Math.PI,!0);c.fill();if(b<r.major)c.beginPath(),c.shadowOffsetX=0,c.shadowOffsetY=0,c.shadowBlur=14,c.shadowColor="rgba(0,240,255,0.9)",c.fillStyle="rgba(0,200,220,0.8)",b<r.major-1?c.arc(a,5,6,0,2*Math.PI,!0):(c.fillStyle="rgba(0,200,220,"+0.8*r.minor+")",c.arc(a,5,6*r.minor,0,2*Math.PI,!1)),c.fill();c.restore()}c.translate(73,
		0);c.font="10px Arial";c.fillStyle="#ffffff";c.fillText("TIME:",0,8);c.font="bold 10px Arial";c.fillStyle="rgba(0,200,220, 0.8)";c.fillText(Math.round(R/1E3)+"s",35,8);c.translate(65,0);c.font="10px Arial";c.fillStyle="#ffffff";c.fillText("SCORE:",0,8);c.font="bold 10px Arial";c.fillStyle="rgba(0,200,220, 0.8)";c.fillText(Math.floor(w),47,8);c.restore();M(0,0,k,Ea+5)}if($a)for(b=J.length;b--;)a=J[b],c.fillStyle="rgba(0,255,0,0.2)",c.fillRect(Math.floor(a.x),Math.floor(a.y),Math.ceil(a.width),Math.ceil(a.height));
	requestAnimFrame(xa)}var W=60,qa=900,ra=510,$a="1"==URLUtil.queryValue("debug"),Ya=2;ENEMY_SIZE=10;var Ea=30,N=600,pa=600,Ca=1,O=2,Za=3,X=4,Ua="playing",ta="loser";STATE_WINNER="winner";var Ba=30,Da=-30,Xa=1,Aa=-30,ma=4,ca=10,fa="server/highscore.php";k=qa;m=ra;x=0;y=0;K=0;Y=0;E=null;q=null;t=null;s=null;var o,c,u,f,J=[],F=!1,z,na,Z,aa,la=0,L,A,Fa,Ga,za,P,wa,ua,g,va,n=0,G=!1,w=0,R=0,S=1,r=new Multiplier(0.2,ma),ea=0,H=0,da=Date.now(),Q=Date.now(),ja=Date.now();Date.now();var ya=0,ka=0,I=0,T=1E3,U=
	0,ia=0,B=[],C=[],D=[],p=[],v=[],i;L=$("#game");A=$("#menu");o=$("#world");u=$("#effects");za=$("#score");Ga=$("#save-button");Fa=$("#start-button");P=$("#lag-warning");wa=$(".highscore-output",A);ua=$(".highscore-input",A);try{f=u.get(0).getContext("webgl")||u.get(0).getContext("experimental-webgl")}catch(ab){}f&&Ha();o.length&&o.get(0).getContext?(c=o.get(0).getContext("2d"),Ga.get(0).addEventListener("click",Ja,!1),Fa.get(0).addEventListener("click",La,!1),P.find("a").get(0).addEventListener("click",
	Na,!1),document.addEventListener("mousedown",Oa,!1),document.addEventListener("mousemove",Pa,!1),document.addEventListener("mouseup",Qa,!1),o.get(0).addEventListener("touchstart",Ra,!1),o.get(0).addEventListener("touchmove",Sa,!1),o.get(0).addEventListener("touchend",Ta,!1),window.addEventListener("resize",ba,!1),ba(),Ia(),oa(),L.fadeIn(N),A.hide().delay(N).fadeIn(N),document.body.setAttribute("class","start"),Wa(),sa(),xa()):alert("Doesn't seem like your browser supports the HTML5 canvas element :(")}();